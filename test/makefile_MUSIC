include Makefile.inc

CXX	= mpicxx-openmpi-gcc5
CXXFLAGS = -std=c++11 -O3 -Wall $(shell gsl-config --cflags)

external_src = ../external_packages/music/src

INCLUDES = -I./$(external_src) -I$(wrapper_src) -I$(jetscape_src)
OBJECTS	= test_MUSIC_main.o music_jetscape.o fluid_dynamics.o
OBJLIBS	= $(external_lib)/libsrc_music.a
LIBS	=  -L$(external_lib) -L$(wrapper_src) $(shell gsl-config --libs)
EXECUTABLE = test_MUSIC_main

all: $(OBJECTS) $(EXECUTABLE)

$(EXECUTABLE): $(OBJECTS) $(OBJLIBS) 
	$(CXX) $(CXXFLAGS) $@.o music_jetscape.o $(OBJLIBS) $(LIBS) -o $@

test_MUSIC_main.o: $(OBJLIBS) test_MUSIC_main.cpp
	$(CXX) $(CXXFLAGS) -c $(INCLUDES) test_MUSIC_main.cpp

music_jetscape.o : $(OBJLIBS) $(wrapper_src)/music_jetscape.cpp
	$(CXX) $(CXXFLAGS) -c $(INCLUDES) $(wrapper_src)/music_jetscape.cpp

fluid_dynamics.o : $(jetscape_src)/fluid_dynamics.cpp
	$(CXX) $(CXXFLAGS) -c $(INCLUDES) $(jetscape_src)/fluid_dynamics.cpp

$(OBJLIBS) : force_look
	cd $(external_src); make -f Makefile_lib


.PHONY: clean # explicitly declare 'clean' to be PHONY
clean :
	-$(RM) -f $(OBJECTS)
	-for d in $(external_src); do (cd $$d; $(MAKE) -f Makefile_lib clean ); done

distclean :
	-$(RM) -f $(EXECUTABLE) $(OBJECTS)
	-for d in $(external_src); do (cd $$d; $(MAKE) -f Makefile_lib clean ); done

force_look :
	true
